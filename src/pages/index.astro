---
import EmptyState from '../components/EmptyState.astro';
import SectionHeader from '../components/SectionHeader.astro';
import TripCard from '../components/TripCard.astro';
import AllTripsShell from '../components/shells/AllTripsShell.astro';
import { allTripsData } from '../data/all-trips';
import { findTripDataModule, getAllTripsSections, getAllTripsStats } from '../lib/trips/all-trips';
import { getAllTripsCardInsights } from '../lib/trips/details';
import { allTripsPage } from './index.page';

const { card, footerNote, headerMetaLabel, intro, meta, sections, stats } = allTripsPage;
const allTripsSections = getAllTripsSections(allTripsData.trips);
const allTripsStats = getAllTripsStats(allTripsData.trips);

const statItems = [
  { label: stats.tripsLabel, value: allTripsStats.totalTrips },
  { label: stats.planningTripsLabel, value: allTripsStats.planningTrips },
  { label: stats.ridesLabel, value: allTripsStats.ridesScouted },
  { label: stats.peopleLabel, value: allTripsStats.nextTripPeople },
  { label: stats.parksLabel, value: allTripsStats.nextTripParks },
];

const sectionLabelByStatus = {
  planning: sections.planningLabel,
  upcoming: sections.upcomingLabel,
  completed: sections.completedLabel,
} as const;

function getTripCardInsights(groupId: string, tripId: string) {
  const tripModule = findTripDataModule(allTripsData.modules, groupId, tripId);

  return tripModule ? getAllTripsCardInsights(tripModule) : [];
}
---

<AllTripsShell
  title={meta.title}
  description={meta.description}
  metaLabel={headerMetaLabel}
  statItems={statItems}
  footerNote={footerNote}
>
  <section class="all-trips-intro">
    <p class="page-label">{intro.label}</p>
    <h1 class="page-title all-trips-intro__title">{intro.title}</h1>
    <p class="page-intro all-trips-intro__body">{intro.body}</p>
  </section>

  {
    allTripsSections.map((section) => (
      <section class="all-trips-section">
        <SectionHeader
          label={sectionLabelByStatus[section.status]}
          countLabel={section.countLabel}
        />

        {section.trips.length > 0 ? (
          <div class:list={['trip-grid', section.trips.length === 1 && 'trip-grid--single']}>
            {section.trips.map((trip) => (
              <TripCard
                trip={trip}
                copy={card}
                insights={
                  trip.status === 'planning' ? getTripCardInsights(trip.groupId, trip.id) : []
                }
              />
            ))}
          </div>
        ) : (
          section.status === 'completed' && <EmptyState text={sections.completedEmptyState} />
        )}
      </section>
    ))
  }
</AllTripsShell>
