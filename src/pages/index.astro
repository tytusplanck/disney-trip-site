---
import EmptyState from '../components/EmptyState.astro';
import SectionHeader from '../components/SectionHeader.astro';
import TripCard from '../components/TripCard.astro';
import ArchiveShell from '../components/shells/ArchiveShell.astro';
import { tripArchiveData } from '../data/trip-archive';
import { findTripDataModule, getArchiveSections, getArchiveStats } from '../lib/trips/archive';
import { getArchiveTripInsights } from '../lib/trips/details';
import { archivePage } from './index.page';

const { footerNote, headerMetaLabel, meta, sections, stats } = archivePage;
const archiveSections = getArchiveSections(tripArchiveData.trips);
const archiveStats = getArchiveStats(tripArchiveData.trips);

const statItems = [
  { label: stats.tripsLabel, value: archiveStats.totalTrips },
  { label: stats.planningTripsLabel, value: archiveStats.planningTrips },
  { label: stats.ridesLabel, value: archiveStats.ridesScouted },
  { label: stats.peopleLabel, value: archiveStats.nextTripPeople },
  { label: stats.parksLabel, value: archiveStats.nextTripParks },
];

const sectionLabelByStatus = {
  planning: sections.planningLabel,
  upcoming: sections.upcomingLabel,
  completed: sections.completedLabel,
} as const;

function getTripInsights(groupId: string, tripId: string) {
  const tripModule = findTripDataModule(tripArchiveData.modules, groupId, tripId);

  return tripModule ? getArchiveTripInsights(tripModule) : [];
}
---

<ArchiveShell
  title={meta.title}
  description={meta.description}
  metaLabel={headerMetaLabel}
  statItems={statItems}
  footerNote={footerNote}
>
  <section class="archive-intro">
    <p class="page-label">Start here</p>
    <h1 class="page-title archive-intro__title">Choose a trip, then open the overview.</h1>
    <p class="page-intro archive-intro__body">
      Every trip opens with a calm summary first. Fast links still get organizers into the full
      planner in one tap.
    </p>
  </section>

  {
    archiveSections.map((section) => (
      <section class="archive-section">
        <SectionHeader
          label={sectionLabelByStatus[section.status]}
          countLabel={section.countLabel}
        />

        {section.trips.length > 0 ? (
          <div class="trip-grid">
            {section.trips.map((trip) => (
              <TripCard
                trip={trip}
                insights={trip.status === 'planning' ? getTripInsights(trip.groupId, trip.id) : []}
              />
            ))}
          </div>
        ) : (
          section.status === 'completed' && <EmptyState text={sections.completedEmptyState} />
        )}
      </section>
    ))
  }
</ArchiveShell>
