---
import EmptyState from '../../../components/EmptyState.astro';
import DisclosurePanel from '../../../components/DisclosurePanel.astro';
import PartyCard from '../../../components/PartyCard.astro';
import PartyClusterBoard from '../../../components/PartyClusterBoard.astro';
import TripPageShell from '../../../components/shells/TripPageShell.astro';
import TripStubShell from '../../../components/shells/TripStubShell.astro';
import { allTripsData } from '../../../data/all-trips';
import { planningStubStatus, tripStubPages, upcomingStubStatus } from '../../../data/trip-stubs';
import { findTripSummary, findTripDataModule } from '../../../lib/trips/all-trips';
import { getPartySummaries } from '../../../lib/trips/details';
import { getPartyClusterView } from '../../../lib/trips/party-insights';
import { hasTripSectionContent } from '../../../lib/trips/readiness';
import { tripSectionPages } from './trip-sections.page';

const familyId = Astro.params['family'] ?? '';
const tripId = Astro.params['trip'] ?? '';
const trip = findTripSummary(allTripsData.trips, familyId, tripId);
const tripModule = findTripDataModule(allTripsData.modules, familyId, tripId);

if (!trip || !tripModule) {
  return Astro.redirect('/');
}

const page = tripSectionPages.party;
const stubPage = tripStubPages.party;
const statusCopy = trip.status === 'upcoming' ? upcomingStubStatus : planningStubStatus;
const tripIsStub = !hasTripSectionContent(tripModule, 'party');
const hasAttractionPreferences = tripModule.attractions.length > 0;
const partySummaries = getPartySummaries(tripModule);
const clusterView = getPartyClusterView(tripModule);
---

{
  tripIsStub ? (
    <TripStubShell
      title={`${trip.title} | Party`}
      description={`Protected placeholder party route for ${trip.title}.`}
      trip={trip}
      activeSection="party"
      pageEyebrow={stubPage.pageLabel}
      pageTitle={stubPage.title}
      pageIntro={`${stubPage.intro} Planning begins soon.`}
      panelEyebrow={statusCopy.eyebrow}
      panelTitle={stubPage.calloutTitle}
      panelBody={`${statusCopy.body} ${stubPage.calloutBody}`}
      checklist={stubPage.checklist}
    />
  ) : (
    <TripPageShell
      title={`${trip.title} | Party`}
      description={`Party view for ${trip.title}.`}
      trip={trip}
      activeSection="party"
      pageEyebrow={page.pageLabel}
      pageTitle={page.title}
      pageIntro={page.intro}
    >
      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Kids vs adults</p>
            <h2 class="section-title">How the younger and older halves pull the plan apart</h2>
          </div>
        </div>

        {hasAttractionPreferences ? (
          <PartyClusterBoard view={clusterView} />
        ) : (
          <EmptyState text="Traveler names are loaded from the current reservations. Attraction-based groupings will appear here after preferences are added." />
        )}
      </section>

      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Traveler cards</p>
            <h2 class="section-title">Open the full traveler breakdown when you need it</h2>
          </div>
        </div>

        <DisclosurePanel
          label="Traveler cards"
          summary="Open every traveler profile"
          detail={
            hasAttractionPreferences
              ? `${partySummaries.length} travelers with full preference counts`
              : `${partySummaries.length} travelers currently loaded from reservations`
          }
          mobileCollapsed
        >
          <div class="party-detail-grid">
            {partySummaries.map((summary) => (
              <PartyCard summary={summary} />
            ))}
          </div>
        </DisclosurePanel>
      </section>
    </TripPageShell>
  )
}
