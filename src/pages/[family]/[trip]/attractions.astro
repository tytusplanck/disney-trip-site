---
import AttractionsScoreGuide from '../../../components/AttractionsScoreGuide.astro';
import AttractionsExplorer from '../../../components/AttractionsExplorer';
import DisclosurePanel from '../../../components/DisclosurePanel.astro';
import TripPageShell from '../../../components/shells/TripPageShell.astro';
import TripStubShell from '../../../components/shells/TripStubShell.astro';
import { allTripsData } from '../../../data/all-trips';
import { planningStubStatus, tripStubPages, upcomingStubStatus } from '../../../data/trip-stubs';
import {
  buildAttractionsExplorerData,
  deriveAttractionsExplorerView,
} from '../../../lib/trips/attractions-explorer';
import { getPreferenceTierPoints } from '../../../lib/trips/data';
import { getPreferenceMeta } from '../../../lib/trips/details';
import { findTripSummary, findTripDataModule } from '../../../lib/trips/all-trips';
import { hasTripSectionContent } from '../../../lib/trips/readiness';
import { tripSectionPages } from './trip-sections.page';

const familyId = Astro.params['family'] ?? '';
const tripId = Astro.params['trip'] ?? '';
const trip = findTripSummary(allTripsData.trips, familyId, tripId);
const tripModule = findTripDataModule(allTripsData.modules, familyId, tripId);

if (!trip || !tripModule) {
  return Astro.redirect('/');
}

const page = tripSectionPages.attractions;
const stubPage = tripStubPages.attractions;
const statusCopy = trip.status === 'upcoming' ? upcomingStubStatus : planningStubStatus;
const tripIsStub = !hasTripSectionContent(tripModule, 'attractions');
const explorerData = buildAttractionsExplorerData(tripModule);
const defaultExplorerView = deriveAttractionsExplorerView(explorerData, {
  selectedDayId: null,
  parkLabel: null,
  areaLabel: null,
  memberId: null,
  sentiment: 'all',
  search: '',
});
const spotlightAttractions = defaultExplorerView.topPicks.slice(0, 3);
const maxScoreLabel = spotlightAttractions[0]?.maxScore ?? tripModule.party.length * 5;
const scoreGuide = ([1, 2, 3, 4, 5] as const).map((tier) => ({
  ...getPreferenceMeta(tier),
  points: getPreferenceTierPoints(tier),
}));
---

{
  tripIsStub ? (
    <TripStubShell
      title={`${trip.title} | Attractions`}
      description={`Protected placeholder attractions route for ${trip.title}.`}
      trip={trip}
      activeSection="attractions"
      pageEyebrow={stubPage.pageLabel}
      pageTitle={stubPage.title}
      pageIntro={`${stubPage.intro} Planning begins soon.`}
      panelEyebrow={statusCopy.eyebrow}
      panelTitle={stubPage.calloutTitle}
      panelBody={`${statusCopy.body} ${stubPage.calloutBody}`}
      checklist={stubPage.checklist}
    />
  ) : (
    <TripPageShell
      title={`${trip.title} | Attractions`}
      description={`Attractions view for ${trip.title}.`}
      trip={trip}
      activeSection="attractions"
      pageEyebrow={page.pageLabel}
      pageTitle={page.title}
      pageIntro={page.intro}
    >
      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Scoring system</p>
            <h2 class="section-title">How the board turns preferences into points</h2>
          </div>
          <p class="trip-page-section__note">
            Every attraction is scored with the same five-tier scale.
          </p>
        </div>

        <DisclosurePanel
          label="Scoring system"
          summary="Open the points guide"
          detail={`How ${tripModule.party.length} ballots become ${maxScoreLabel} max points`}
          defaultOpen={false}
        >
          <AttractionsScoreGuide
            maxScoreLabel={maxScoreLabel}
            partySize={tripModule.party.length}
            scoreGuide={scoreGuide}
          />
        </DisclosurePanel>
      </section>

      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Decision board</p>
            <h2 class="section-title">Filter down to the right ride stack for the day</h2>
          </div>
          <p class="trip-page-section__note">
            Start broad, then cut the board down by park day, area, traveler, and group signal.
          </p>
        </div>

        <AttractionsExplorer client:load data={explorerData} />
      </section>

      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Best bets</p>
            <h2 class="section-title">Highest-confidence picks</h2>
          </div>
          <p class="trip-page-section__note">Scored out of {maxScoreLabel} possible group points</p>
        </div>

        <div class="featured-grid">
          {spotlightAttractions.map((attraction, index) => (
            <article class="featured-attraction">
              <p class="featured-attraction__eyebrow">#{index + 1} group signal</p>
              <h3 class="featured-attraction__title">{attraction.attractionLabel}</h3>
              <p class="featured-attraction__meta">
                {attraction.parkLabel} / {attraction.areaLabel}
              </p>
              <p class="featured-attraction__score">
                {attraction.consensusScore}/{attraction.maxScore} with {attraction.mustDoVotes}{' '}
                must-do calls
              </p>
            </article>
          ))}
        </div>
      </section>
    </TripPageShell>
  )
}
