---
import ChipList from '../../../components/ChipList.astro';
import DetailStatGrid from '../../../components/DetailStatGrid.astro';
import DisclosurePanel from '../../../components/DisclosurePanel.astro';
import ScheduleDayCard from '../../../components/ScheduleDayCard.astro';
import TripPageShell from '../../../components/shells/TripPageShell.astro';
import TripStubShell from '../../../components/shells/TripStubShell.astro';
import { tripArchiveData } from '../../../data/trip-archive';
import { planningStubStatus, tripStubPages, upcomingStubStatus } from '../../../data/trip-stubs';
import { findArchiveTrip, findTripDataModule } from '../../../lib/trips/archive';
import { getScheduleDaySummaries, getScheduleOverview } from '../../../lib/trips/details';
import { tripSectionPages } from './trip-sections.page';

const familyId = Astro.params['family'] ?? '';
const tripId = Astro.params['trip'] ?? '';
const trip = findArchiveTrip(tripArchiveData.trips, familyId, tripId);
const tripModule = findTripDataModule(tripArchiveData.modules, familyId, tripId);

if (!trip || !tripModule) {
  return Astro.redirect('/');
}

const page = tripSectionPages.schedule;
const stubPage = tripStubPages.schedule;
const statusCopy = trip.status === 'upcoming' ? upcomingStubStatus : planningStubStatus;
const scheduleOverview = getScheduleOverview(tripModule.schedule);
const scheduleDays = getScheduleDaySummaries(tripModule.schedule);
const scheduleSummaryText = `${scheduleOverview.parkDays} park day${
  scheduleOverview.parkDays === 1 ? '' : 's'
} are buffered by ${scheduleOverview.resortDays} resort day${
  scheduleOverview.resortDays === 1 ? '' : 's'
}, with ${scheduleOverview.travelDays} travel day${
  scheduleOverview.travelDays === 1 ? '' : 's'
} holding the edges of the trip. The park lineup is already clear even before timed reservations are locked.`;
const scheduleStats = [
  {
    label: 'Park days',
    value: String(scheduleOverview.parkDays),
    detail: `${scheduleOverview.parkLineup.length} unique parks planned`,
  },
  {
    label: 'Resort resets',
    value: String(scheduleOverview.resortDays),
    detail: 'Quiet days between the heavier park pushes',
  },
  {
    label: 'Travel days',
    value: String(scheduleOverview.travelDays),
    detail: 'Arrival and departure hold the edges of the trip',
  },
  {
    label: 'Logged notes',
    value: String(scheduleOverview.scheduledNotes),
    detail: 'Meals, holds, and reminders carried over from the CSV',
  },
];
---

{
  trip.status === 'upcoming' ? (
    <TripStubShell
      title={`${trip.title} | Schedule`}
      description={`Protected placeholder schedule route for ${trip.title}.`}
      trip={trip}
      activeSection="schedule"
      pageEyebrow={stubPage.pageLabel}
      pageTitle={stubPage.title}
      pageIntro={`${stubPage.intro} Planning begins soon.`}
      panelEyebrow={statusCopy.eyebrow}
      panelTitle={stubPage.calloutTitle}
      panelBody={`${statusCopy.body} ${stubPage.calloutBody}`}
      checklist={stubPage.checklist}
    />
  ) : (
    <TripPageShell
      title={`${trip.title} | Schedule`}
      description={`Schedule view for ${trip.title}.`}
      trip={trip}
      activeSection="schedule"
      pageEyebrow={page.pageLabel}
      pageTitle={page.title}
      pageIntro={page.intro}
    >
      <DetailStatGrid items={scheduleStats} />

      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Trip rhythm</p>
            <h2 class="section-title">Park cadence and reset days</h2>
          </div>
          <p class="trip-page-section__note">Built directly from the current itinerary sheet.</p>
        </div>

        <article class="schedule-summary-card">
          <p class="schedule-summary-card__text">{scheduleSummaryText}</p>

          <div class="schedule-summary-card__chips">
            <ChipList items={scheduleOverview.parkLineup} />
          </div>
        </article>
      </section>

      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Daily board</p>
            <h2 class="section-title">Open the full itinerary when you need every day card</h2>
          </div>
          <p class="trip-page-section__note">
            Day cards stay close to the source sheet but collapse down cleanly on phones.
          </p>
        </div>

        <DisclosurePanel
          label="Full itinerary"
          summary="Open every day card"
          detail={`${scheduleDays.length} trip days with notes and park labels`}
          mobileCollapsed
        >
          <div class="schedule-grid">
            {scheduleDays.map((day) => (
              <ScheduleDayCard day={day} />
            ))}
          </div>
        </DisclosurePanel>
      </section>
    </TripPageShell>
  )
}
