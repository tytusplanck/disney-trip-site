---
import ChipList from '../../../components/ChipList.astro';
import DisclosurePanel from '../../../components/DisclosurePanel.astro';
import ScheduleDayCard from '../../../components/ScheduleDayCard.astro';
import TripPageShell from '../../../components/shells/TripPageShell.astro';
import TripStubShell from '../../../components/shells/TripStubShell.astro';
import { allTripsData } from '../../../data/all-trips';
import { planningStubStatus, tripStubPages, upcomingStubStatus } from '../../../data/trip-stubs';
import { findTripSummary, findTripDataModule } from '../../../lib/trips/all-trips';
import { getScheduleDaySummaries, getScheduleOverview } from '../../../lib/trips/details';
import { hasTripSectionContent } from '../../../lib/trips/readiness';
import { tripSectionPages } from './trip-sections.page';

const familyId = Astro.params['family'] ?? '';
const tripId = Astro.params['trip'] ?? '';
const trip = findTripSummary(allTripsData.trips, familyId, tripId);
const tripModule = findTripDataModule(allTripsData.modules, familyId, tripId);

if (!trip || !tripModule) {
  return Astro.redirect('/');
}

const page = tripSectionPages.schedule;
const stubPage = tripStubPages.schedule;
const statusCopy = trip.status === 'upcoming' ? upcomingStubStatus : planningStubStatus;
const tripIsStub = !hasTripSectionContent(tripModule, 'schedule');
const scheduleOverview = getScheduleOverview(tripModule.schedule);
const scheduleDays = getScheduleDaySummaries(tripModule.schedule);
const scheduleSummaryText = `${scheduleOverview.parkDays} park day${
  scheduleOverview.parkDays === 1 ? '' : 's'
} are buffered by ${scheduleOverview.resortDays} resort day${
  scheduleOverview.resortDays === 1 ? '' : 's'
}, with ${scheduleOverview.travelDays} travel day${
  scheduleOverview.travelDays === 1 ? '' : 's'
} holding the edges of the trip. The park lineup is already clear even before timed reservations are locked.`;
---

{
  tripIsStub ? (
    <TripStubShell
      title={`${trip.title} | Schedule`}
      description={`Protected placeholder schedule route for ${trip.title}.`}
      trip={trip}
      activeSection="schedule"
      pageEyebrow={stubPage.pageLabel}
      pageTitle={stubPage.title}
      pageIntro={`${stubPage.intro} Planning begins soon.`}
      panelEyebrow={statusCopy.eyebrow}
      panelTitle={stubPage.calloutTitle}
      panelBody={`${statusCopy.body} ${stubPage.calloutBody}`}
      checklist={stubPage.checklist}
    />
  ) : (
    <TripPageShell
      title={`${trip.title} | Schedule`}
      description={`Schedule view for ${trip.title}.`}
      trip={trip}
      activeSection="schedule"
      pageEyebrow={page.pageLabel}
      pageTitle={page.title}
      pageIntro={page.intro}
    >
      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Trip rhythm</p>
            <h2 class="section-title">Park cadence and reset days</h2>
          </div>
        </div>

        <article class="schedule-summary-card">
          <p class="schedule-summary-card__text">{scheduleSummaryText}</p>

          <div class="schedule-summary-card__chips">
            <ChipList items={scheduleOverview.parkLineup} />
          </div>
        </article>
      </section>

      <section class="trip-page-section">
        <div class="trip-page-section__header">
          <div class="trip-page-section__copy">
            <p class="page-label">Daily board</p>
            <h2 class="section-title">Open the full itinerary when you need every day card</h2>
          </div>
        </div>

        <DisclosurePanel
          label="Full itinerary"
          summary="Open every day card"
          detail={`${scheduleDays.length} trip days with notes and park labels`}
          mobileCollapsed
        >
          <div class="schedule-grid">
            {scheduleDays.map((day) => (
              <ScheduleDayCard day={day} />
            ))}
          </div>
        </DisclosurePanel>
      </section>
    </TripPageShell>
  )
}
